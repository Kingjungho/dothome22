<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캐럿!</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
        integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
</head>

<body>
    <section class="game">
        <header class="game__header">
            <button class="game__start"><i class="fas fa-play"></i></button>
            <span class="game__timer">0:10</span>
            <span class="game__score">9</span>
        </header>
        <section class="game__field"></section>
    </section>
    <section class="pop-up pop-up-hide">
        <button class="pop-up__refresh">
            <i class="fas fa-redo"></i>
        </button>
        <span class="pop-up__message"></span>
    </section>

    <script>
        const start = document.querySelector(".game__start");
        const timer = document.querySelector(".game__timer");
        const score = document.querySelector(".game__score");
        const field = document.querySelector(".game__field");
        const popUp = document.querySelector(".pop-up");
        const popUpRefresh = document.querySelector(".pop-up__refresh");
        const popUpMessage = document.querySelector(".pop-up__message");
        const fieldRect = field.getBoundingClientRect();

        // 사운드
        const bugSound = new Audio('./sound/bug_pull.mp3');
        const bgSound = new Audio('./sound/bg.mp3');
        const carrotSound = new Audio('./sound/carrot_pull.mp3');
        const alertSound = new Audio('./sound/alert.wav');
        const winSound = new Audio('./sound/game_win.mp3');

        const CARROT_SIZE = 80;
        const CARROT_COUNT = 5;
        const GAME_DURATION_SEC = 5;
        const gameInit = () => {
            gameScore = 0;
            field.innerHTML = '';
            score.innerText = CARROT_COUNT;
            //게임의 초깂값 설정
            addItem('carrot', CARROT_COUNT, 'img/carrot.png')
            addItem('bug', CARROT_COUNT, 'img/bug.png')
            soundMusic(bgSound)
        }

        started = false;
        let gameTimer;
        gameScore = 0;

        const onFieldClick = e => {
            if (!started) {
                return;
            }
            const target = e.target;
            if (target.matches('.carrot')) {
                target.remove();
                gameScore++;
                soundMusic(carrotSound)
                scoreBoard()
                if(gameScore === CARROT_COUNT){
                    finishGame(true);
                    clearInterval(gameTimer);
                    timer.innerText = "0:00";
                }
            } else if (target.matches('.bug')) {
                finishGame(false);
                timer.innerText = "0:00";
                soundMusic(bugSound)
            }
        }

        const soundMusic = (sound) => {
            sound.play();
        }

        const scoreBoard = () => {
            score.innerText = CARROT_COUNT - gameScore;
        
        }
        const finishGame = (win) => {
            if(win){
                soundMusic(winSound)
            } else {
                soundMusic(alertSound)
            }
            started = false;
            stopGameTimer()
            hideStartBtn();
            showPopUpandText(win? 'yo~!' : '장애인ㅋ')
        }

        field.addEventListener("click", onFieldClick)
        start.addEventListener("click", () => {
            if (started) {
                gameStop();
            } else {
                gameStart();
            }
        })

        

        const gameStart = () => {
            started = true;
            gameInit();
            buttonChange();
            showStartBtn();
            startGameTimer();
        }

        const gameStop = () => {
            started = false;
            stopGameTimer()
            hideStartBtn()
            showPopUpandText('Replay?!');
        }

        const buttonChange = () => {
            const icon = start.querySelector(".fas");
            icon.classList.remove("fa-play")
            icon.classList.add('fa-stop');
        }

        const showStartBtn = () => {
            timer.style.visibility = "visible"
            score.style.visibility = "visible"
        }

        const hideStartBtn = () => {
            start.style.visibility = 'hidden'
        }

        const startGameTimer = () => {
            let remainingTime = GAME_DURATION_SEC;
            updateTimerText(remainingTime);
            gameTimer = setInterval(() => {
                if (remainingTime <= 0) {
                    clearInterval(gameTimer)
                    finishGame(gameScore === CARROT_COUNT)
                    return;
                }
                updateTimerText(--remainingTime)
            }, 1000)
        }

        const stopGameTimer = () => {
            clearInterval(gameTimer)
        }
        const showPopUpandText = (text) => {
            popUp.classList.remove("pop-up-hide");
            popUpMessage.innerText = text;
        }
        const updateTimerText = (time) => {
            const minute =Math.floor(time / 60)
            const second = String(time % 60).padStart(2, "0")
            timer.innerText = `${minute}: ${second}`;
        }

        const replayGame = () => {
            gameStart();
            popUp.classList.add("pop-up-hide");
        }
        popUpRefresh.addEventListener('click', replayGame)

        const addItem = (className, count, imgName) => {
            for (let i = 0; i < count; i++) {
                const item = document.createElement("img");
                item.setAttribute('class', className);
                item.src = imgName;
                const x1 = 0;
                const y1 = 0;
                const x2 = fieldRect.width - CARROT_SIZE;
                const y2 = fieldRect.height - CARROT_SIZE;
                const x = randomLocation(x1, x2);
                const y = randomLocation(y1, y2);
                item.style.position = "absolute"
                item.style.left = `${x}px`
                item.style.top = `${y}px`
                field.append(item);
            }
        }

        const randomLocation = (min, max) => {
            return Math.random() * (max - min) + min;
        }

        const init = () => {
            addItem('bug', 5, 'img/bug.png')
            addItem('carrot', 5, 'img/carrot.png')
        }

        const addItem = (className, number, img) => {
            const bug = document.createElement("img");
            bug.src = img;
            
        }

        

    </script>
</body>

</html>